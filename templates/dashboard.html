{% extends "base.html" %}
{% block content %}

<style>

/* ================= DASHBOARD ONLY STYLES ================= */

h1 {
    font-size: 30px;
    margin-bottom: 6px;
    color: var(--accent);
}

.subtitle {
    color: var(--text-muted);
}

.dashboard-grid {
    margin-top: 28px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
    gap: 26px;
}

/* CARD */

.card {
    position: relative;
    display: flex;
    align-items: center;
    gap: 22px;
    padding: 26px 34px;
    border-radius: 22px;
    cursor: pointer;
    overflow: hidden;

    background: var(--card-bg);
    box-shadow: 0 16px 40px rgba(0,0,0,0.25);
    transition: transform .25s ease, box-shadow .25s ease;
}

.card:hover {
    transform: translateY(-6px);
    box-shadow: 0 20px 50px rgba(0,0,0,.35);
}

.card::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    width: 8px;
    height: 100%;
    background: var(--primary);
    border-radius: 22px 0 0 22px;
}

/* CONTENT */

.icon {
    font-size: 36px;
}

.content h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.value {
    font-size: 30px;
    font-weight: 700;
    margin-top: 4px;
    color: var(--primary);
}

.subtext {
    margin-top: 4px;
    font-size: 14px;
    color: var(--text-muted);
}

/* PROGRESS */

.progress-wrap { margin-top: 10px; }

.progress-label {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.progress-bar {
    width: 100%;
    height: 10px;
    background: rgba(0,0,0,0.08);
    border-radius: 20px;
    overflow: hidden;
}

 .progress-fill {
    background: linear-gradient(
        90deg,
        var(--primary, #1C2E5A),
        var(--accent, #FFD97D)
    );
}


/* RIPPLE */

.ripple {
    position: absolute;
    border-radius: 50%;
    transform: scale(0);
    animation: ripple 600ms linear;
    background: rgba(255,255,255,0.6);
}

@keyframes ripple {
    to { transform: scale(4); opacity: 0; }
}

</style>

<h1>Dashboard</h1>
<div class="subtitle">Your weekly survival overview</div>

<div class="dashboard-grid">

    <!-- ATTENDANCE -->
    <div class="card" onclick="go('/attendance', event)">
        <div class="icon">üìä</div>
        <div class="content">
            <h2>Attendance Health</h2>
            <div class="value count" data-target="{{ overall_attendance }}">0</div>
            <div class="subtext">Average attendance across subjects</div>
            <div class="subtext">{{ attendance_insight }}</div>

            <div class="progress-wrap">
                <div class="progress-label">
                    This week: {{ weekly_attendance }}%
                </div>
                <div class="progress-bar">
                    <div class="progress-fill"
                         style="width: {{ weekly_attendance }}%">
                    </div>
                </div>
            </div>

            <canvas id="attendanceSparkline"
                    width="260"
                    height="60"></canvas>
        </div>
    </div>

    <!-- RISK -->
    <div class="card" onclick="go('/weekly-danger', event)">
        <div class="icon">‚ö†</div>
        <div class="content">
            <h2>Subjects at Risk</h2>
            <div class="value count"
                 data-target="{{ subjects_at_risk }}">0</div>
            <div class="subtext">
                Below 80% attendance
            </div>
        </div>
    </div>

    <!-- DEADLINES -->
    <div class="card" onclick="go('/deadlines', event)">
        <div class="icon">‚è∞</div>
        <div class="content">
            <h2>Coming Up Soon</h2>
            <div class="value count"
                 data-target="{{ urgent_deadlines }}">0</div>
            <div class="subtext">
                Deadlines in next 7 days
            </div>
        </div>
    </div>

    <!-- TODAY -->
    <div class="card" onclick="go('/timetable', event)">
        <div class="icon">üìö</div>
        <div class="content">
            <h2>Today‚Äôs Classes</h2>
            <div class="value count"
                 data-target="{{ todays_classes }}">0</div>
            <div class="subtext">
                Classes scheduled today
            </div>
        </div>
    </div>

    <!-- SAFE -->
    <div class="card" onclick="go('/subjects', event)">
        <div class="icon">‚úÖ</div>
        <div class="content">
            <h2>On Track</h2>
            <div class="value count"
                 data-target="{{ safe_subjects }}">0</div>
            <div class="subtext">
                Subjects meeting attendance rules
            </div>
        </div>
    </div>

</div>

<script>

/* Card Ripple + Navigation */
function go(url, event) {
    const card = event.currentTarget;
    const circle = document.createElement("span");
    const d = Math.max(card.clientWidth, card.clientHeight);
    circle.style.width = circle.style.height = d + "px";
    circle.style.left = event.clientX - card.offsetLeft - d/2 + "px";
    circle.style.top = event.clientY - card.offsetTop - d/2 + "px";
    circle.className = "ripple";
    card.appendChild(circle);
    setTimeout(() => location.href = url, 180);
}

/* Count Animation */
document.querySelectorAll(".count").forEach(el => {
    const target = parseInt(el.dataset.target) || 0;
    let count = 0;

    if (target === 0) {
        el.textContent = 0;
        return;
    }

    const interval = setInterval(() => {
        count++;
        el.textContent = count;
        if (count >= target) clearInterval(interval);
    }, 20);
});

/* Sparkline */
const data = {{ attendance_trend | tojson }};
if (data.length > 1) {
    const c = document.getElementById("attendanceSparkline");
    const ctx = c.getContext("2d");
    const w = c.width, h = c.height, p = 8;
    const max = Math.max(...data);
    const min = Math.min(...data);

    ctx.strokeStyle = getComputedStyle(document.body)
        .getPropertyValue('--primary');
    ctx.lineWidth = 2;
    ctx.beginPath();

    data.forEach((v,i)=>{
        const x = p + i*(w-p*2)/(data.length-1);
        const y = h - p - (v-min)*(h-p*2)/(max-min||1);
        i ? ctx.lineTo(x,y) : ctx.moveTo(x,y);
    });

    ctx.stroke();
}

</script>

{% endblock %}

